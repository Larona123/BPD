<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
		           https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">


    <changeSet id="v1-project-dashboard-schema" author="pramodimo">

        <!-- CLIENT TABLE -->
        <createTable tableName="client">
            <column name="id" type="SERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(100)"/>
            <column name="phone" type="VARCHAR(30)"/>
            <column name="company_name" type="VARCHAR(100)"/>
        </createTable>

        <!-- PROJECT TABLE -->
        <createTable tableName="project">
            <column name="id" type="SERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(150)">
                <constraints nullable="false"/>
            </column>
            <column name="budget" type="NUMERIC(12,2)"/>
            <column name="description" type="TEXT"/>
            <column name="start_date" type="DATE"/>
            <column name="end_date" type="DATE"/>
            <column name="client_id" type="INTEGER"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="project" baseColumnNames="client_id"
                                 referencedTableName="client" referencedColumnNames="id"
                                 onDelete="SET NULL" constraintName="fk_project_client"/>

        <!-- PERFORMANCE TABLE -->
        <createTable tableName="performance">
            <column name="id" type="SERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="planned_expenditure" type="NUMERIC(12,2)"/>
            <column name="actual_expenditure" type="NUMERIC(12,2)"/>
            <column name="planned_schedule" type="NUMERIC(5,2)"/>
            <column name="actual_schedule" type="NUMERIC(5,2)"/>
            <column name="project_id" type="INTEGER"/>
        </createTable>

        <addUniqueConstraint columnNames="project_id" tableName="performance" constraintName="uk_performance_project"/>
        <addForeignKeyConstraint baseTableName="performance" baseColumnNames="project_id"
                                 referencedTableName="project" referencedColumnNames="id"
                                 onDelete="CASCADE" constraintName="fk_performance_project"/>

        <!-- RISK TABLE -->
        <createTable tableName="risk">
            <column name="id" type="SERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="description" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="impact" type="VARCHAR(50)"/>
            <column name="likelihood" type="VARCHAR(50)"/>
            <column name="project_id" type="INTEGER"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="risk" baseColumnNames="project_id"
                                 referencedTableName="project" referencedColumnNames="id"
                                 onDelete="CASCADE" constraintName="fk_risk_project"/>

        <!-- ISSUE TABLE -->
        <createTable tableName="issue">
            <column name="id" type="SERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="description" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="severity" type="VARCHAR(50)"/>
            <column name="status" type="VARCHAR(50)"/>
            <column name="project_id" type="INTEGER"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="issue" baseColumnNames="project_id"
                                 referencedTableName="project" referencedColumnNames="id"
                                 onDelete="CASCADE" constraintName="fk_issue_project"/>

        <!-- RESOURCE TABLE -->
        <createTable tableName="resource">
            <column name="id" type="SERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="project_id" type="INTEGER"/>
            <column name="dtype" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="resource" baseColumnNames="project_id"
                                 referencedTableName="project" referencedColumnNames="id"
                                 onDelete="CASCADE" constraintName="fk_resource_project"/>

        <!-- HUMAN RESOURCE TABLE -->
        <createTable tableName="human_resource">
            <column name="id" type="INTEGER">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="role" type="VARCHAR(100)"/>
            <column name="hourly_rate" type="NUMERIC(10,2)"/>
            <column name="hours_allocated" type="INTEGER"/>
            <column name="start_date" type="DATE"/>
            <column name="end_date" type="DATE"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="human_resource" baseColumnNames="id"
                                 referencedTableName="resource" referencedColumnNames="id"
                                 onDelete="CASCADE" constraintName="fk_human_resource_resource"/>

        <!-- HARDWARE RESOURCE TABLE -->
        <createTable tableName="hardware_resource">
            <column name="id" type="INTEGER">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="vendor" type="VARCHAR(100)"/>
            <column name="serial_number" type="VARCHAR(100)"/>
            <column name="under_warranty" type="BOOLEAN"/>
            <column name="allocation_date" type="DATE"/>
            <column name="return_date" type="DATE"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="hardware_resource" baseColumnNames="id"
                                 referencedTableName="resource" referencedColumnNames="id"
                                 onDelete="CASCADE" constraintName="fk_hardware_resource_resource"/>

    </changeSet>


    <changeSet id="v2-user-management-schema" author="pramodimo">

        <!-- USERS TABLE -->
        <createTable tableName="users">
            <column name="id" type="SERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="first_name" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="last_name" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <!-- Password must be long enough for BCrypt hash -->
            <column name="password" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="role" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Add an index to the email column for faster lookups -->
        <createIndex tableName="users" indexName="idx_user_email" unique="true">
            <column name="email"/>
        </createIndex>

    </changeSet>


    <changeSet id="v1-2-add-cost-to-resource" author="pramodimo">
        <comment>Adds the missing cost column to the resource parent table.</comment>
        <addColumn tableName="resource">
            <column name="cost" type="NUMERIC(10,2)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="v1-4-update-project-entities" author="pramodimo">
        <comment>Updates client (add phone_number), hardware_resource (drop vendor), restructures risk (drop impact/likelihood, add severity/owner/date_raised/mitigation_plan), and adds columns to the existing issue table (title, priority, reported_on, reported_by).</comment>

        <!-- 1. CLIENT TABLE UPDATE: Add phone_number -->
        <addColumn tableName="client">
            <column name="phone_number" type="VARCHAR(30)"/>
        </addColumn>

        <!-- 2. HARDWARE RESOURCE TABLE UPDATE: Remove vendor -->
        <dropColumn tableName="hardware_resource" columnName="vendor"/>

        <!-- 3. RISK TABLE RESTRUCTURE: Drop old columns first -->
        <dropColumn tableName="risk" columnName="impact"/>
        <dropColumn tableName="risk" columnName="likelihood"/>

        <!-- 4. RISK TABLE RESTRUCTURE: Add all required new columns -->
        <addColumn tableName="risk">
            <column name="severity" type="VARCHAR(50)"/>
        </addColumn>
        <addColumn tableName="risk">
            <column name="owner" type="VARCHAR(100)"/>
        </addColumn>
        <addColumn tableName="risk">
            <column name="date_raised" type="DATE"/>
        </addColumn>
        <addColumn tableName="risk">
            <column name="mitigation_plan" type="TEXT"/>
        </addColumn>

        <!-- 5. ISSUE TABLE UPDATE: Add all missing columns to the EXISTING table -->
        <addColumn tableName="issue">
            <column name="title" type="VARCHAR(150)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="issue">
            <column name="priority" type="VARCHAR(50)"/>
        </addColumn>
        <addColumn tableName="issue">
            <column name="reported_on" type="DATE"/>
        </addColumn>
        <addColumn tableName="issue">
            <column name="reported_by" type="VARCHAR(100)"/>
        </addColumn>

    </changeSet>

    <!-- TASK MANAGEMENT TABLE -->
    <changeSet id="v1-5-add-task-management" author="pramodimo">
        <comment>Adds the Task table for project management.</comment>
        <createTable tableName="tasks">
            <column name="id" type="SERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="task_description" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <column name="assignee" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="priority" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="due_date" type="DATE"/>
            <column name="project_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="tasks" baseColumnNames="project_id"
                                 referencedTableName="project" referencedColumnNames="id"
                                 onDelete="CASCADE" constraintName="fk_task_project"/>
    </changeSet>


    <!-- NEW BUDGET TABLE ADDITION -->
    <changeSet id="v1-6-add-budget-table" author="pramodimo">
        <comment>Adds the Budget table for tracking project hours, expenditure, and status.</comment>
        <createTable tableName="budget">
            <column name="id" type="SERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="planned_hours" type="NUMERIC(10,2)"/>
            <column name="actual_hours" type="NUMERIC(10,2)"/>
            <column name="planned_expenditure" type="NUMERIC(12,2)"/>
            <column name="actual_expenditure" type="NUMERIC(12,2)"/>
            <column name="planned_time_duration" type="NUMERIC(10,2)"/>
            <column name="actual_time_duration" type="NUMERIC(10,2)"/>
            <column name="planned_budget" type="NUMERIC(12,2)"/>
            <column name="actual_budget" type="NUMERIC(12,2)"/>
            <column name="percent_spent" type="NUMERIC(5,2)"/>
            <column name="remaining" type="NUMERIC(12,2)"/>
            <column name="status" type="VARCHAR(50)"/>
            <column name="notes" type="VARCHAR(1000)"/>

            <column name="project_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="budget" baseColumnNames="project_id"
                                 referencedTableName="project" referencedColumnNames="id"
                                 onDelete="CASCADE" constraintName="fk_budget_project"/>
    </changeSet>

    <changeSet id="v1-7-add-task-assignment-fields" author="pramodimo">
        <comment>Adds the assigned_by and date_assigned columns to the tasks table.</comment>

        <addColumn tableName="tasks">
            <column name="assigned_by" type="VARCHAR(100)">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <addColumn tableName="tasks">
            <column name="date_assigned" type="DATE">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="1.0.1-1" author="pramodimo">
        <comment>Adding 'status' column to the 'project' table for project tracking. Using VARCHAR(50) for optimized enum storage.</comment>

        <addColumn tableName="project">
            <column name="status" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
        </addColumn>

    </changeSet>

    <changeSet id="v1-8-add-project-manager" author="pramodimo">
        <comment>Adds the project_manager column to the project table for accountability.</comment>
        <addColumn tableName="project">
            <column name="project_manager" type="VARCHAR(100)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="v1-9-add-status-to-risk" author="pramodimo">
        <comment>Adds the 'status' column to the 'risk' table to track whether a risk is open or closed.</comment>
        <addColumn tableName="risk">
            <column name="status" type="VARCHAR(50)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

</databaseChangeLog>
